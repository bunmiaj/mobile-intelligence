---
title: "visualize_mobile_data"
author: "[Truc Viet 'Joe' Le](mailto:tjle@andrew.cmu.edu)"
date: "April 3, 2015"
output: html_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(ig.width=6, fig.height=6, fig.path='./figures/mobile/',
                      warning=FALSE)
```

This tutorial explores basic spatial visualization techniques for the **mobile phone dataset**. Specifically, we will explore two visualization techniques: spatial bubble plot and population graph. Spatial bubble plot is a simple techinque to visualize the distribution of "events" over space, where each "event" is any incident of interest that can be described by its spatial coordinates and that happens during the specfied duration. Each bubble is visually scaled by the number of events that happen nearby and are mapped to its coordinates. [Population graph](http://dyerlab.github.io/popgraph/) is a new concept introduced by [Dyer and Nason](http://www.ncbi.nlm.nih.gov/pubmed/15189198) to visualize both the distribution of events over space and the relationships among those events. In other words, it is a graph laid over a spatial map, where each node of the graph is an event and each edge represents the relationship between a pair of events. In this tutorial, we will use the [`popgraph`](http://cran.r-project.org/web/packages/popgraph/index.html) package to plot population graphs.

First, make sure that you have cloned and/or updated the [GitHub repository](https://github.com/vietexob/mobile-intelligence) that hosts the project. Then, go to the project directory, it should be named "mobile-intelligence" by default. This is **important**: Use **RStudio** to open the project file `mobile-intelligence.Rproj` in the directory. You should have now set the path correctly. Now, load the useful packages as always. We will use them for retrieving the data and plotting them on a map.

```{r load_packages, include=TRUE}
library(rmongodb)
library(ggplot2)
library(ggmap) ## for plotting maps
library(igraph) ## for plotting graphs
library(popgraph) ## for plotting population graphs
library(scales) ## for plot formatting 
library(plyr) ## for data manipulation
```

Now load the necessary data that we are going to use. Refer to the [previous tutorial](http://vietletruc.com/wp-content/uploads/2015/03/cell_locations.html) if you're not sure why we need to load these data.

```{r load_data}
## Read the cell towers spatial coordinates
cell.towers <- read.csv(file="./data/mobile/cell_coord.csv", stringsAsFactors=FALSE)
## Load the cell_id rowIndex mapping
load("./data/mobile/cell_id_rowIndex_mapping.RData")
```

We now connect to the remote MongoDB server as we did before, and use the `cellular` collection. Refer to the [previous tutorial](http://vietletruc.com/wp-content/uploads/2015/03/cell_locations.html) if you don't know how to.

```{r server_connection, include=FALSE}
## Login credentials
host <- "heinz-tjle.heinz.cmu.edu"
username <- "student"
password <- "helloWorld"
db <- "admin"
## Connect to MongoDB remote server
mongo <- mongo.create(host = host, db = db, username = username, password = password)
## Check if we are successfully connected
mongo.is.connected(mongo)
## The database we're working with is 'admin' and the collection is 'cellular'
collection <- "cellular"
namespace <- paste(db, collection, sep=".")
```



```{r retrieve_frequencies}
## First group the IMEI's by frequency
pipe_1 <- mongo.bson.from.JSON(
  '{"$group":
    {"_id": "$imei", "count": {"$sum": 1}}
  }'
)
## Get those whose call frequencies are at least 100
pipe_2 <- mongo.bson.from.JSON(
  '{"$match": {"count": {"$gte": 100}}}'
)
## And those whose call frequencies are no more than 300
pipe_3 <- mongo.bson.from.JSON(
  '{"$match": {"count": {"$lte": 300}}}'
)
pipeline <- list(pipe_1, pipe_2, pipe_3)
imei.distr <- mongo.aggregation(mongo, namespace, pipeline)
```




